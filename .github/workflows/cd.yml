name: CD — Deploy All Services

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false # Never cancel an in-flight deploy

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/ayurveda

jobs:
  # ─── Build & push Docker images in parallel per service ──────────────────
  build:
    name: Build & Push — ${{ matrix.service }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service:
          - auth-service
          - api-gateway
          - user-service
          - product-service
          - inventory-service
          - cart-service
          - order-service
          - payment-service
          - notification-service
          - admin-service
      fail-fast: false # Build all services even if one fails

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            type=sha,prefix=${{ matrix.service }}-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          build-args: SERVICE=${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  # ─── Deploy to server after all images are built ─────────────────────────
  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/ayurveda

            # Pull latest compose file
            git pull origin main

            # Log in to GHCR using a PAT (GITHUB_TOKEN is not available in SSH context)
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull new images
            docker compose pull

            # Rolling restart with zero downtime (restart one at a time)
            services=(
              "auth-service"
              "api-gateway"
              "user-service"
              "product-service"
              "inventory-service"
              "cart-service"
              "order-service"
              "payment-service"
              "notification-service"
              "admin-service"
            )

            for service in "${services[@]}"; do
              echo "Restarting $service..."
              docker compose up -d --no-deps "$service"
              sleep 5
            done

            # Remove dangling images
            docker image prune -f

  # ─── Deploy web frontend to Vercel ───────────────────────────────────────
  deploy-web:
    name: Deploy Web to Vercel
    needs: build # only deploy after all Docker images built successfully
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: apps/web
          vercel-args: "--prod"
