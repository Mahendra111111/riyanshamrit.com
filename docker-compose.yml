version: "3.9"

# ─── Shared network for all services ──────────────────────────────────────────
networks:
  ayurveda:
    driver: bridge

# ─── Persistent volumes ────────────────────────────────────────────────────────
volumes:
  redis_data:

services:
  # ─── Infrastructure ───────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: ayurveda-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    networks:
      - ayurveda
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── API Gateway (port 3000) ───────────────────────────────────────────────
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: api-gateway
    container_name: ayurveda-api-gateway
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file: apps/api-gateway/.env
    networks:
      - ayurveda
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ─── Auth Service (port 3001) ──────────────────────────────────────────────
  auth-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: auth-service
    container_name: ayurveda-auth-service
    restart: unless-stopped
    ports:
      - "3001:3001"
    env_file: apps/auth-service/.env
    networks:
      - ayurveda
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ─── User Service (port 3003) ──────────────────────────────────────────────
  user-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: user-service
    container_name: ayurveda-user-service
    restart: unless-stopped
    ports:
      - "3003:3003"
    env_file: apps/user-service/.env
    networks:
      - ayurveda
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3003/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ─── Product Service (port 3004) ───────────────────────────────────────────
  product-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: product-service
    container_name: ayurveda-product-service
    restart: unless-stopped
    ports:
      - "3004:3004"
    env_file: apps/product-service/.env
    networks:
      - ayurveda
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3004/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ─── Inventory Service (port 3005 — internal only) ─────────────────────────
  inventory-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: inventory-service
    container_name: ayurveda-inventory-service
    restart: unless-stopped
    # No host-facing port — internal network only
    expose:
      - "3005"
    env_file: apps/inventory-service/.env
    networks:
      - ayurveda
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3005/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ─── Cart Service (port 3006) ──────────────────────────────────────────────
  cart-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: cart-service
    container_name: ayurveda-cart-service
    restart: unless-stopped
    ports:
      - "3006:3006"
    env_file: apps/cart-service/.env
    networks:
      - ayurveda
    depends_on:
      redis:
        condition: service_healthy

  # ─── Order Service (port 3007) ─────────────────────────────────────────────
  order-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: order-service
    container_name: ayurveda-order-service
    restart: unless-stopped
    ports:
      - "3007:3007"
    env_file: apps/order-service/.env
    networks:
      - ayurveda
    depends_on:
      redis:
        condition: service_healthy
      inventory-service:
        condition: service_healthy

  # ─── Payment Service (port 3008) ───────────────────────────────────────────
  payment-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: payment-service
    container_name: ayurveda-payment-service
    restart: unless-stopped
    ports:
      - "3008:3008"
    env_file: apps/payment-service/.env
    networks:
      - ayurveda
    depends_on:
      redis:
        condition: service_healthy
      inventory-service:
        condition: service_healthy

  # ─── Notification Service (port 3009 — health only) ────────────────────────
  notification-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: notification-service
    container_name: ayurveda-notification-service
    restart: unless-stopped
    expose:
      - "3009"
    env_file: apps/notification-service/.env
    networks:
      - ayurveda
    depends_on:
      redis:
        condition: service_healthy

  # ─── Admin Service (port 3010) ─────────────────────────────────────────────
  admin-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: admin-service
    container_name: ayurveda-admin-service
    restart: unless-stopped
    ports:
      - "3010:3010"
    env_file: apps/admin-service/.env
    networks:
      - ayurveda

  # ─── Nginx Reverse Proxy (port 80 / 443) ──────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    container_name: ayurveda-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - ayurveda
    depends_on:
      - api-gateway
